<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Start Session</title>
    <link type="text/css" rel="stylesheet" href="bulma.min.css" />
    <link type="text/css" rel="stylesheet" href="index.css" />
    <link type="text/css" rel="stylesheet" href="fa/css/all.min.css" />
</head>
<body>
<div id="content-load-init">
    <div class="content" style="padding: 16px;">
        <h4>Load Authorization Manifest</h4>
        <p>
            Buka file Authorization Manifest untuk sesi pemilihan ini.
            <br />
            Authorization Manifest adalah sebuah file yang berisi kunci otentikasi mesin.
        </p>
        <div style="margin-top: 32px;">
            <div class="field has-addons">
                <div class="control">
                    <a class="button is-info" id="open-manifest">
                        Open File
                    </a>
                </div>
                <div class="control is-expanded">
                    <input class="input" type="text" id="manifest-path" readonly>
                </div>
            </div>
        </div>
    </div>
    <div style="position:absolute; width: 100%; left: 0; bottom: 0; padding: 16px;">
        <div style="float: right">
            <a class="button is-rounded is-primary" href="javascript: next1()" disabled="disabled" id="next1">Berikutnya &nbsp; <i class="fas fa-chevron-right"></i></a>
        </div>
    </div>
</div>

<div id="content-pick-dest" style="display: none;">
    <div class="content" style="padding: 16px;">
        <h4>Join Cluster</h4>
        <p>
            Pilih cluster yang sudah ada pada jaringan yang sama, atau buat cluster baru.
        </p>
        <div style="margin-top: 32px;">

        </div>
    </div>
    <div style="position:absolute; width: 100%; left: 0; bottom: 0; padding: 16px;">
        <div style="float: left">
            <a class="button is-rounded" href="javascript: back2()"><i class="fas fa-chevron-left"></i> &nbsp; Kembali</a>
        </div>
        <div style="float: right">
            <a class="button is-rounded is-primary" href="javascript: next2()" disabled="disabled" id="next2">Berikutnya &nbsp; <i class="fas fa-chevron-right"></i></a>
        </div>
    </div>
</div>

<div id="content-setting-up" style="display: none;">
    <div class="content" style="padding: 16px;">
        <h4>Setting up</h4>
        <p>
            Kami sedang mempersiapkan sesi pemilihan, tunggu sebentar..
        </p>
        <pre id="log"></pre>
    </div>
</div>

<script type="text/javascript">
    const {dialog} = require('electron').remote;
    const ipcRenderer = require('electron').ipcRenderer;
    const fs = require('fs');

    let manifest, dest;

    document.querySelector('#open-manifest').addEventListener('click', function (event) {
        dialog.showOpenDialog({
            properties: ['openFile'],
            title: "Open Authorization Manifest",
            filters: [{name: 'Machine Authorization Manifest', extensions: ['json', 'vmn']}]
        }, function (manifestPath) {
            if (manifestPath !== undefined) {
                document.querySelector('#manifest-path').value = manifestPath[0];
                document.querySelector('#next1').removeAttribute("disabled");

                manifest = manifestPath[0];
            }
        });
    });

    function next1() {
        if(!document.querySelector('#next1').hasAttribute("disabled")) {
            document.querySelector('#next1').setAttribute("disabled", "disabled");

            ipcRenderer.send("load_auth", manifest);
            ipcRenderer.on('load_auth-reply', (event, success, msg) => {
                document.querySelector('#next1').removeAttribute("disabled");

                if(success) {
                    document.querySelector('#content-load-init').style.display = 'none';
                    document.querySelector('#content-pick-dest').style.display = 'inherit';
                } else {
                    alert(msg);
                }
            });
        }
    }

    function back2() {
        document.querySelector('#content-load-init').style.display = 'inherit';
        document.querySelector('#content-pick-dest').style.display = 'none';
    }

    function next2() {
        if(!document.querySelector('#next2').hasAttribute("disabled")) {
            document.querySelector('#content-pick-dest').style.display = 'none';
            document.querySelector('#content-setting-up').style.display = 'inherit';

            ipcRenderer.send("start_session", manifest, dest);
            ipcRenderer.on('start_session-reply', (event, finished, error, msg) => {
                if(error === null) {
                    if(!finished) {
                        document.querySelector('#log').innerHTML += msg + '\n';
                    } else {
                        document.querySelector('#log').innerHTML += '<b style="color: green">Selesai!</b>';
                        document.querySelector('#next3').removeAttribute("disabled");
                    }
                } else {
                    document.querySelector('#log').innerHTML += '<b style="color: red">' + error + '</b>\n';
                }
            })
        }
    }
</script>
</body>
</html>